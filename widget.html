<!DOCTYPE html>
<html>
    <head>
        <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    </head>
    <body>
        <div id="main">
            <h3>My Widget</h3>
            <p>Fetching hidden field values...</p>
            <div id="hidden-values-output"></div>
        </div>
        <script type="text/javascript">
            // Function to log all elements in the widget for debugging
            function logAllElements() {
                console.log("Logging all elements in the iframe:");
                console.log(document.body.innerHTML);
            }

            // Function to locate and log hidden field values
            function fetchHiddenFields() {
                console.log("Attempting to fetch hidden fields...");
                const wrapper = document.querySelector('.widget-inputs-wrapper');

                if (wrapper) {
                    const hiddenFields = wrapper.querySelectorAll('input[type="hidden"]');
                    if (hiddenFields.length > 0) {
                        const hiddenValues = Array.from(hiddenFields).map(input => ({
                            name: input.name,
                            value: input.value,
                        }));
                        console.log("Hidden field values found:", hiddenValues);

                        // Display the values in the widget
                        const outputDiv = document.getElementById('hidden-values-output');
                        outputDiv.innerHTML = `<pre>${JSON.stringify(hiddenValues, null, 2)}</pre>`;
                    } else {
                        console.warn("No hidden fields found inside .widget-inputs-wrapper.");
                    }
                } else {
                    console.warn(".widget-inputs-wrapper not found in the DOM.");
                }
            }

            // Function to retry locating hidden fields with a time delay
            function retryFetchHiddenFields(attempts = 10) {
                if (attempts === 0) {
                    console.error("Failed to locate hidden fields after multiple attempts.");
                    logAllElements(); // Log all elements for debugging
                    return;
                }

                setTimeout(() => {
                    console.log(`Retrying... (${11 - attempts}/10)`);
                    fetchHiddenFields();
                    retryFetchHiddenFields(attempts - 1);
                }, 500); // Retry every 500ms
            }

            // Always subscribe to the ready event
            JFCustomWidget.subscribe("ready", function () {
                console.log("Widget is ready. Starting hidden field fetch attempts...");
                retryFetchHiddenFields(); // Start fetching hidden fields

                // Handle form submission
                JFCustomWidget.subscribe("submit", function () {
                    console.log("Form submission detected. Re-fetching hidden fields...");
                    fetchHiddenFields();

                    // Send placeholder data to JotForm
                    const msg = {
                        valid: true,
                        value: { status: 'Submitted' },
                    };
                    JFCustomWidget.sendSubmit(msg);
                });
            });
        </script>
    </body>
</html>