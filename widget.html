<!DOCTYPE html>
<html>
    <head>
        <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    </head>
    <body>
        <div id="main">
            <h3>My Widget</h3>
            <p>Fetching hidden field values...</p>
            <div id="hidden-values-output"></div>
        </div>
        <script type="text/javascript">
            // Function to log hidden field values
            function fetchAndLogHiddenFields() {
                console.log("Attempting to fetch hidden fields...");
                const wrapper = document.querySelector('.widget-inputs-wrapper');

                if (wrapper) {
                    const hiddenFields = wrapper.querySelectorAll('input[type="hidden"]');
                    if (hiddenFields.length > 0) {
                        const hiddenValues = Array.from(hiddenFields).map(input => ({
                            name: input.name,
                            value: input.value,
                        }));
                        console.log("Hidden field values found:", hiddenValues);

                        // Display the values in the widget
                        const outputDiv = document.getElementById('hidden-values-output');
                        outputDiv.innerHTML = `<pre>${JSON.stringify(hiddenValues, null, 2)}</pre>`;
                    } else {
                        console.warn("No hidden fields found inside .widget-inputs-wrapper.");
                    }
                } else {
                    console.warn(".widget-inputs-wrapper not found in the DOM.");
                }
            }

            // Function to observe dynamic DOM changes
            function observeDOMChanges() {
                const observer = new MutationObserver((mutations) => {
                    for (const mutation of mutations) {
                        if (mutation.type === 'childList') {
                            console.log("DOM mutation detected. Checking for hidden fields...");
                            fetchAndLogHiddenFields();
                        }
                    }
                });

                // Start observing the body for changes
                observer.observe(document.body, { childList: true, subtree: true });
                console.log("Started observing DOM for changes.");
            }

            // Retry fetching hidden fields multiple times
            function retryFetchHiddenFields(attempts = 10) {
                if (attempts === 0) {
                    console.error("Failed to locate hidden fields after multiple attempts.");
                    console.log("Logging entire DOM for debugging...");
                    console.log(document.body.innerHTML); // Log full DOM
                    return;
                }

                setTimeout(() => {
                    console.log(`Retrying... (${11 - attempts}/10)`);
                    fetchAndLogHiddenFields();
                    retryFetchHiddenFields(attempts - 1);
                }, 500); // Retry every 500ms
            }

            // Widget initialization
            JFCustomWidget.subscribe("ready", function () {
                console.log("Widget is ready.");
                fetchAndLogHiddenFields(); // Initial fetch
                retryFetchHiddenFields(); // Retry if needed
                observeDOMChanges(); // Monitor for dynamic changes
            });
        </script>
    </body>
</html>