<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Widget Example</title>
</head>
<body>
    <h1>Dynamic Widget Example</h1>
    <p>This widget will log data passed from the parent form and display fields dynamically.</p>

    <form id="dynamicForm">
        <!-- Dynamic fields will be appended here -->
    </form>

    <button id="submitBtn">Submit Form</button>

    <script>
        // Function to dynamically create fields based on data from the form
        function setupFormFields(fields) {
            const formElement = document.getElementById('dynamicForm');

            // Clear any existing fields
            formElement.innerHTML = '';

            // Create fields dynamically based on received data
            fields.forEach((field, index) => {
                const fieldWrapper = document.createElement('div');
                fieldWrapper.style.marginBottom = '10px';

                const label = document.createElement('label');
                label.textContent = `${field.label || `Field ${index + 1}`}: `;
                label.setAttribute('for', `field_${index + 1}`);

                const input = document.createElement('input');
                input.type = 'text';
                input.id = `field_${index + 1}`;
                input.name = field.name || `field_${index + 1}`;
                input.value = field.value || ''; // Pre-fill value if provided
                input.placeholder = field.placeholder || `Placeholder Field ${index + 1}`;

                fieldWrapper.appendChild(label);
                fieldWrapper.appendChild(input);

                formElement.appendChild(fieldWrapper);
            });
        }

        // Function to log all field names and values to the console
        function logAllFields() {
            const formElement = document.getElementById('dynamicForm');
            const inputs = formElement.querySelectorAll('input');
            const fields = {};

            inputs.forEach((input) => {
                fields[input.name] = input.value;
            });

            console.log('Field values:', fields);
        }

        // Event listener to handle messages from the parent form
        window.addEventListener('message', (event) => {
            // Ensure the message comes from the expected origin (for security)
            if (!event.origin.includes('jotform.com')) {
                console.warn('Message from unauthorized origin:', event.origin);
                return;
            }

            const data = event.data;

            // Check if data contains fields information
            if (data.fields) {
                console.log('Received fields from parent form:', data.fields);

                // Set up the form fields dynamically
                setupFormFields(data.fields);

                // Log fields after 2 seconds (for demonstration)
                setTimeout(logAllFields, 2000);
            } else {
                console.warn('No fields data received from parent form.');
            }
        });

        // Simulate submission for testing
        document.getElementById('submitBtn').addEventListener('click', (event) => {
            event.preventDefault();
            console.log('Submit button clicked!');
            logAllFields();
        });

        // Example of sending a "ready" message to the parent form
        window.parent.postMessage({ event: 'widgetReady' }, '*');
    </script>
</body>
</html>